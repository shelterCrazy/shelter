const ChromaJs=require("chroma-js"),Message=require("../Message.js");var GravityTool={draw:null,angle:0,len:1,mul:10,_svg:{line1:null,line2:null,arrow:null,group:null},_onMsg(t){if(t.msg===Message.MessageUpdateGravity){let e={x:t.data.x,y:t.data.y};GravityTool._initGravity(e),GravityTool._updateSvg()}},_initGravity(t){this.len=Math.sqrt(t.x*t.x+t.y*t.y)/this.mul,this.angle=Math.atan(t.y/t.x),0===this.angle?0===t.y&&0!==t.x?t.x>0?this.angle=0:this.angle=180:0!==t.y&&0===t.x&&(t.y>0?this.angle=-90:this.angle=90):this.angle=180*this.angle/Math.PI,t.x>=0&&t.y>=0?this.angle=-this.angle:t.x>=0&&t.y<=0?this.angle=-this.angle:t.x<=0&&t.y>=0?this.angle=-(180+this.angle):t.x<=0&&t.y<=0&&(this.angle=180-this.angle)},init(t){window.plugin.$on(Message.MessagePipe,this._onMsg),this._svg.arrow=this._svg.line1=this._svg.line2=this._svg.group=null,this.draw=t;let e=this.draw.group(),s=window.particle.script.gravity;this._initGravity(s);let i="#ff0000",o=this.draw.line(0,0,100,0).stroke({width:1,color:i}),n=this.draw.line(0,0,100,0).stroke({width:8,color:i,opacity:0});e.add(o),e.add(n),e.style("cursor","move"),this._onElementEvent(e,o,function(t){t.stopImmediatePropagation();let s=e.x(),i=e.y(),o=t.offsetX,n=t.offsetY,a=o-s,l=n-i,r=Math.atan(l/a);r=180*r/Math.PI,o>=s&&n>=i||(o<=s&&n>=i?r=180-Math.abs(r):o>=s&&n<=i||o<=s&&n<=i&&(r=-(r=180-r))),e.rotate(r,0,0),this.angle=r,this._updateGravity()}.bind(this),i);let a=this.draw.polyline("100,5,100,-5,115,0");return a.stroke({color:i,width:1}).fill(i),a.style("cursor","pointer"),this._onElementEvent(a,a,function(t){t.stopImmediatePropagation();let s=e.x(),i=e.y(),l=t.offsetX,r=t.offsetY,h=l-s,g=r-i,u=Math.atan(g/h);u=Math.abs(180*u/Math.PI),l>=s&&r>=i||(l<=s&&r>=i?u=180-u:l>=s&&r<=i?u=-u:l<=s&&r<=i&&(u=-(u=180-u)));let v=e.transform().rotation-u,d=Math.cos(v*Math.PI/180),m=d*=Math.sqrt(h*h+g*g);d>=0&&(a.plot(`${m},5,${m},-5,${m+15},0`),o.plot(0,0,m,0),n.plot(0,0,m,0),this.len=m,this._updateGravity())}.bind(this),i),e.add(a),this._svg.line2=n,this._svg.line1=o,this._svg.arrow=a,this._svg.group=e,setTimeout(this._updateSvg.bind(this),0),e},_updateSvg(){this._svg.group.rotate(this.angle,0,0);let t=this.len;this._svg.line1.plot(0,0,t,0),this._svg.line2.plot(0,0,t,0),this._svg.arrow.plot(`${t},5,${t},-5,${t+15},0`)},_updateGravity(){let t=this.angle,e={x:Math.cos(t*Math.PI/180),y:Math.sin(t*Math.PI/180)},s=this.len*this.mul;e.x*=s,e.y*=s,window.particle.setGravity(e.x,-e.y)},_onElementEvent(t,e,s,i){let o=i||"#ff0000",n=ChromaJs(o).brighten(1).hex(),a=ChromaJs(o).brighten(2).hex();function l(t){e.stroke({color:o}),document.removeEventListener("mouseup",l),document.removeEventListener("mousemove",r)}function r(t){s&&s(t)}t.on("mouseover",function(){e.stroke({color:n})}),t.on("mouseout",function(){e.stroke({color:o})}),t.on("mousedown",function(t){e.stroke({color:a}),document.addEventListener("mousemove",r),document.addEventListener("mouseup",l)})}};module.exports=GravityTool;
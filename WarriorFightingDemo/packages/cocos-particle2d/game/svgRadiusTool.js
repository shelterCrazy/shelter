const ChromaJs=require("chroma-js"),Message=require("../Message.js");var RadiusTool={draw:null,endRadius:0,startRadius:0,rotationPres:0,_svg:{},init(t,e,s,i){this.draw=t,this.endRadius=e,this.startRadius=s,this.rotationPres=i,window.plugin.$on(Message.MessagePipe,this._onMsg);let r=this.draw.group(),o=(this.endRadius,this.startRadius,this.getArrowDrawCmd(this.endRadius,this.startRadius)),a=this.draw.polyline(o);a.stroke({color:"#ffff00",width:1,opacity:1}).fill("#ffff00");let d=this.getArrowLineDrawCmd(this.endRadius,this.startRadius),n=this.draw.line(d).stroke({color:"#ffff00",width:1,opacity:1});return r.add(a),r.add(n),this._svg.arrow=a,this._svg.arrowLine=n,this._svg.maxCircle=this._createCircle(2,r,this.endRadius,function(t,e){this.endRadius=e,this.updateArrow(this.endRadius,this.startRadius)}.bind(this)),this._svg.minCircle=this._createCircle(1,r,this.startRadius,function(t,e){this.startRadius=e,this.updateArrow(this.endRadius,this.startRadius)}.bind(this),"#00ff00"),r},getArrowDrawCmd(t,e){let s=t-e;return s>=15?`${t-15},5,${t-15},-5,${t},0`:s<=-15?`${t+15},5,${t+15},-5,${t},0`:"0,0,0,0"},getArrowLineDrawCmd(t,e){let s=t-e;return s>=15?`${e},0,${t},0`:s<=-15?`${t},0,${e},0`:"0,0,0,0"},updateArrow(t,e){let s=this.getArrowDrawCmd(t,e);this._svg.arrow.plot(s),this._svg.arrowLine.plot(this.getArrowLineDrawCmd(t,e)),window.particle.setRadius(t,e)},_createCircle(t,e,s,i,r){r=r||"#ff0000";let o=this.draw.circle(2*s).stroke({color:r,width:t}).fill("none");o.move(-s,-s),e.add(o);let a=this.draw.circle(2*s).stroke({color:r,width:8,opacity:0}).fill("none");return a.move(-s,-s),a.style("cursor","move"),e.add(a),this._onElementEvent(a,o,function(t){let s=t.movementY;if(0===t.movementX&&0===s);else{let s={x:t.offsetX,y:t.offsetY},r={x:e.x(),y:e.y()},d=s.x-r.x,n=s.y-r.y,u=Math.sqrt(d*d+n*n);o.rx(u).move(-u,-u),a.rx(u).move(-u,-u),i&&i(t,u)}}.bind(this),r),{circle:o,circleBg:a}},updateCircle(){let t=this.endRadius;this._svg.maxCircle.circle.rx(t).move(-t,-t),this._svg.maxCircle.circleBg.rx(t).move(-t,-t);let e=this.startRadius;this._svg.minCircle.circle.rx(e).move(-e,-e),this._svg.minCircle.circleBg.rx(e).move(-e,-e)},_onElementEvent(t,e,s,i){let r=i||"#ff0000",o=ChromaJs(r).brighten(1).hex(),a=ChromaJs(r).brighten(2).hex();function d(t){e.stroke({color:r}),document.removeEventListener("mouseup",d),document.removeEventListener("mousemove",n)}function n(t){s&&s(t)}t.on("mouseover",function(){e.stroke({color:o})}),t.on("mouseout",function(){e.stroke({color:r})}),t.on("mousedown",function(t){e.stroke({color:a}),document.addEventListener("mousemove",n),document.addEventListener("mouseup",d)})},_onMsg(t){t.msg===Message.MessageUpdateRadius&&(RadiusTool.endRadius=t.data.end,RadiusTool.startRadius=t.data.start,RadiusTool.updateArrow(t.data.end,t.data.start),RadiusTool.updateCircle())}};module.exports=RadiusTool;
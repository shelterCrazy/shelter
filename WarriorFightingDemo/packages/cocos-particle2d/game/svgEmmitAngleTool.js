const ChromaJs=require("chroma-js"),Message=require("../Message.js");var AngleTool={angle:0,speed:0,angleVariance:0,emmitSpeed:150,draw:null,_svg:{rootGroup:null,varianceLineTop:null,varianceLineBottom:null,arrowLineBg:null,arrowLine:null,arrowHead:null,arc:null},_onMsg(e){e.msg===Message.MessageUpdateAngleVar?(AngleTool.angleVariance=e.data,AngleTool._updateAngle(AngleTool.angleVariance)):e.msg===Message.MessageUpdateAngle?(AngleTool.angle=-e.data,AngleTool.speed<0&&(AngleTool.angle>=0?AngleTool.angle-=180:AngleTool.angle+=180),AngleTool._onAngleLineEvent(AngleTool.angle)):e.msg===Message.MessageUpdateGravitySpeed&&(AngleTool.speed=e.data,AngleTool._onUpdateGravitySpeed(AngleTool.speed))},init(e,t,o){window.plugin.$on(Message.MessagePipe,this._onMsg),this._svg.varianceLineBottom=null,this._svg.varianceLineTop=null,this._svg.arrowHead=null,this._svg.arrowLineBg=null,this._svg.arrowLine=null,this._svg.arc=null,this.angle=t,this.angleVariance=o;let n=window.particle.getEmmitAngle();this.speed=n.speed,this.angle=n.angle,this.angleVariance=n.angleVar,this.draw=e;let s=this.draw.group(),i="#ff0000";setTimeout(function(){s.rotate(-this.angle,0,0)}.bind(this),0);let r=this.speed,a=this.draw.group(),l=this.draw.group();this._svg.arrowLine=this.draw.line(0,0,r,0).stroke({color:i,width:1}),this._svg.arrowLineBg=this.draw.line(0,0,r,0).stroke({color:i,width:8,opacity:0}),l.add(this._svg.arrowLineBg),l.add(this._svg.arrowLine),this._svg.arrowHead=r>=0?this.draw.polyline(`${r},5,${r},-5,${r+15},0`):this.draw.polyline(`${r},5,${r},-5,${r-15},0`),this._svg.arrowHead.stroke({color:i,width:1}).fill(i),a.add(l),a.add(this._svg.arrowHead),s.add(a),this._svg.rootGroup=s,this._onArrowHeadEvent(this._svg.arrowHead,function(e){let t=s.x(),o=s.y(),n=(this._svg.arrowHead.x(),this._svg.arrowHead.y(),e.offsetX),i=e.offsetY,r=n-t,a=i-o,l=Math.atan(a/r);l=Math.abs(180*l/Math.PI),n>=t&&i>=o||(n<=t&&i>=o?l=180-l:n>=t&&i<=o?l=-l:n<=t&&i<=o&&(l=-(l=180-l)));let g=this._svg.rootGroup.transform().rotation-l,d=Math.cos(g*Math.PI/180);d*=Math.sqrt(r*r+a*a),this._onUpdateGravitySpeed(d)}.bind(this)),this._onArrowLineEvent(l,function(e){let t=this._getAngle(e);this._onAngleLineEvent(t)}.bind(this));let g=this.draw.group();s.add(g);let d=this.draw.path("M 0 0").stroke({color:i,width:1}).fill("none");this._svg.arc=d,g.add(d);let h=this._createAngleVarianceLine(0,0,this._onAngleVarianceLineMove.bind(this),"#ff9089");this._svg.varianceLineBottom=h;let u=this._createAngleVarianceLine(0,0,this._onAngleVarianceLineMove.bind(this));return this._svg.varianceLineTop=u,g.add(h),g.add(u),this._updateAngle(this.angleVariance),s},_onUpdateGravitySpeed(e){e>=0?this._svg.arrowHead.plot(`${e},5,${e},-5,${e+15},0`):this._svg.arrowHead.plot(`${e},5,${e},-5,${e-15},0`),this._svg.arrowLine.plot(0,0,e,0),this._svg.arrowLineBg.plot(0,0,e,0),this.speed=e,window.particle.setEmmitSpeed(e)},_onAngleLineEvent(e){this.speed<0&&(e>=0?e-=180:e+=180),this.angle=e,this._svg.rootGroup.rotate(e,0,0),window.particle.updateEmmitAngle(-e)},_onAngleVarianceLineMove(e){let t=e.movementX;if(0===e.movementY&&0===t);else{let t=this._getMoveAngle(e)-this._svg.rootGroup.transform().rotation;t>=180?t=360-t:t<=-180&&(t=360+t),this.angleVariance=t,this._updateAngle(this.angleVariance),window.particle&&window.particle.updateEmmitAngleVar(this.angleVariance)}},_getAngle(e){let t=this._svg.rootGroup,o=t.x(),n=t.y(),s=e.offsetX,i=e.offsetY,r=s-o,a=i-n,l=Math.atan(a/r),g=Math.abs(180*l/Math.PI);return s>=o&&i>=n||(s<=o&&i>=n?g=180-g:s>=o&&i<=n?g=-g:s<=o&&i<=n&&(g=-(g=180-g))),g},_getMoveAngle(e){let t=this._svg.rootGroup,o=t.x(),n=t.y(),s=e.offsetX,i=e.offsetY,r=s-o,a=i-n,l=Math.atan(a/r),g=Math.abs(180*l/Math.PI);return s>=o&&i>=n||(s<=o&&i>=n?g=180-g:s>=o&&i<=n?g=-g:s<=o&&i<=n&&(g=-(g=180-g))),g},_updateAngle(e){e=Math.abs(e);let t=100,o={x:0,y:0};o.x=t*Math.cos(e*Math.PI/180),o.y=t*Math.sin(e*Math.PI/180),this._svg.varianceLineTop.updateAngle(o.x,-o.y),this._svg.varianceLineBottom.updateAngle(o.x,o.y);let n=0;0<=e&&e<=90?n=0:90<=e&&e<=180?n=1:180<=e&&e<=270?n=1:270<=e&&e<=360&&(n=0);let s=o.x,i=o.y,r=`M ${s} ${-i} A 100 100 0 ${n} 1 ${s} ${i}`;this._svg.arc.plot(r)},_onArrowHeadEvent(e,t,o){let n=o||"#ff0000",s=ChromaJs(n).brighten(1).hex(),i=ChromaJs(n).brighten(2).hex(),r=this._svg.arrowHead;function a(e){r.stroke({color:n}).fill(n),document.removeEventListener("mouseup",a),document.removeEventListener("mousemove",l)}function l(e){t&&t(e)}e.on("mouseover",function(){r.stroke({color:s}).fill(s)}.bind(this)),e.on("mouseout",function(){r.stroke({color:n}).fill(n)}.bind(this)),e.on("mousedown",function(e){r.stroke({color:i}).fill(n),document.addEventListener("mousemove",l),document.addEventListener("mouseup",a)}),e.style("cursor","pointer")},_onArrowLineEvent(e,t,o){let n=o||"#ff0000",s=ChromaJs(n).brighten(1).hex(),i=ChromaJs(n).brighten(2).hex(),r=(this._svg.arrowLineBg,this._svg.arrowLine);function a(e){r.stroke({color:n}),document.removeEventListener("mouseup",a),document.removeEventListener("mousemove",l)}function l(e){t&&t(e)}e.style("cursor","move"),e.on("mouseover",function(){r.stroke({color:s})}.bind(this)),e.on("mouseout",function(){r.stroke({color:n})}.bind(this)),e.on("mousedown",function(e){r.stroke({color:i}),document.addEventListener("mousemove",l),document.addEventListener("mouseup",a)})},_createAngleVarianceLine(e,t,o,n){let s=this.draw.group();s.style("cursor","move");let i=n||"#008e00",r=ChromaJs(i).brighten(1).hex(),a=ChromaJs(i).brighten(2).hex(),l=this.draw.line(0,0,e,t).stroke({color:i,width:1}),g=this.draw.line(0,0,e,t).stroke({width:8,color:i,opacity:0}).attr({fill:i});function d(e){l.stroke({color:i}),document.removeEventListener("mouseup",d),document.removeEventListener("mousemove",h)}function h(e){o&&o(e)}return s.add(l),s.add(g),s.on("mouseover",function(){l.stroke({color:r})}),s.on("mouseout",function(){l.stroke({color:i})}),s.on("mousedown",function(e){l.stroke({color:a}),document.addEventListener("mousemove",h),document.addEventListener("mouseup",d)}),s.updateAngle=function(e,t){l.plot(0,0,e,t),g.plot(0,0,e,t)},s}};module.exports=AngleTool;